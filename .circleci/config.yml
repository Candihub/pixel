version: 2
jobs:

  build_frontend:
    working_directory: ~/pixel
    docker:
      - image: circleci/node:8
        environment:
          CI_BUILD_FRONTEND: 1
    steps:
      - checkout
      - restore_cache:
          keys:
          - frontend-deps-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Install dependencies & build styles
          command: |
            make bootstrap
      - save_cache:
          paths:
            - ~/pixel/static
            - ~/pixel/node_modules
          key: frontend-deps-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}

  build_backend:
    machine: true
    steps:
      - checkout
      - restore_cache:
          keys:
          - frontend-deps-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Login to DockerHub
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS
      - run:
          name: Build container
          command: |
            docker build -t candihub/pixel:$CIRCLE_BRANCH-dev --build-arg DEVELOPMENT="true" .
      - run:
          name: Publish container
          command: |
            docker push candihub/pixel:$CIRCLE_BRANCH-dev

  lint_backend:
    machine: true
    steps:
      - run:
          name: Lint the code
          command: |
            docker run candihub/pixel:$CIRCLE_BRANCH-dev flake8

  test_backend:
    machine: true
    steps:
      - run:
          name: Test the code
          command: |
            docker run candihub/pixel:$CIRCLE_BRANCH-dev pytest
      - run:
          name: Report code coverage
          command: |
            docker run candihub/pixel:$CIRCLE_BRANCH-dev coveralls
          when: on_success

workflows:
  version: 2

  pixel:
    jobs:
      - build_frontend
      - build_backend:
          requires:
            - build_frontend
      - lint_backend:
          requires:
            - build_backend
      - test_backend:
          requires:
            - build_backend
